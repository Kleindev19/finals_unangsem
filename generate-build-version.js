/* generate-build-version.js */
const fs = require('fs');
const childProcess = require('child_process');

// 0. Ensure we are in the root
if (!fs.existsSync('./package.json')) {
    console.error("❌ Error: package.json not found. Run this from the project root.");
    process.exit(1);
}

const packageJson = require('./package.json');

// 1. Get version from package.json
const appVersion = packageJson.version;

// 2. Get latest git commit hash (short)
let commitHash = 'dev-build';
try {
    // Only run git if the .git folder exists to avoid errors in non-git environments
    if (fs.existsSync('.git')) {
        commitHash = childProcess
            .execSync('git rev-parse --short HEAD')
            .toString()
            .trim();
    }
} catch (e) {
    console.warn('⚠️ Git hash could not be retrieved. Using default.');
}

// 3. Create the content
const fileContent = `
// This file is auto-generated by generate-build-version.js
// Do not edit directly.
export const APP_VERSION = "${appVersion}";
export const BUILD_HASH = "${commitHash}";
export const BUILD_DATE = "${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}";
`;

// 4. Save to src/meta.js
try {
    // Ensure src directory exists
    if (!fs.existsSync('./src')) {
        fs.mkdirSync('./src');
    }
    fs.writeFileSync('./src/meta.js', fileContent);
    console.log(`✅ Build version generated: v${appVersion} (${commitHash})`);
} catch (error) {
    console.error("❌ Failed to write meta.js:", error);
    process.exit(1);
}